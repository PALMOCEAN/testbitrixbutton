<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã</title>
    <script src="//api.bitrix24.com/api/v1/"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <style>
        body {
            padding: 15px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }
        .list-group-item {
            cursor: pointer;
            transition: all 0.2s;
        }
        .list-group-item:hover {
            background-color: #f8f9fa;
            transform: translateX(5px);
        }
        .category-header {
            background-color: #e9ecef;
            font-weight: bold;
            cursor: default;
        }
        .category-header:hover {
            background-color: #e9ecef;
            transform: none;
        }
        #loadButton, #installButton {
            margin-bottom: 15px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }
        .badge {
            font-size: 0.7em;
            margin-left: 5px;
        }
        .alert {
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- –ê–ª–µ—Ä—Ç –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ -->
        <div id="installAlert" style="display: none;"></div>
        
        <!-- –ö–Ω–æ–ø–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ placement –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω) -->
        <button id="installButton" class="btn btn-success w-100" onclick="installPlacement()" style="display: none;">
            üìå –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤ —á–∞—Ç
        </button>
        
        <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–≤–µ—Ç–æ–≤ -->
        <button id="loadButton" class="btn btn-primary w-100" onclick="loadAnswers()">
            –ó–∞–≥—Ä—É–∑–∏—Ç—å –æ—Ç–≤–µ—Ç—ã
        </button>
        
        <div id="loadingIndicator" class="loading" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ —à–∞–±–ª–æ–Ω–æ–≤...</p>
        </div>
        
        <ul class="list-group" id="answerList"></ul>
    </div>

<script type="text/javascript">
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —à–∞–±–ª–æ–Ω–æ–≤
    const templates = {
        'greeting': {
            title: 'üëã –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ',
            items: [
                {
                    title: '–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ',
                    message: '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –†–∞–¥ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –≤–∞—Å. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?',
                    action: 'greeting',
                    badge: '–°—Ç–∞–Ω–¥–∞—Ä—Ç'
                },
                {
                    title: '–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ (–≤–µ—á–µ—Ä)',
                    message: '–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä! –ß–µ–º –º–æ–≥—É –±—ã—Ç—å –ø–æ–ª–µ–∑–µ–Ω?',
                    action: 'greeting_evening',
                    badge: '–í–µ—á–µ—Ä'
                }
            ]
        },
        'info': {
            title: 'üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è',
            items: [
                {
                    title: '–°–ø–∏—Å–æ–∫ —Å–∫–ª–∞–¥–æ–≤',
                    message: '–ù–∞—à–∏ —Å–∫–ª–∞–¥—ã:\n1. –ú–æ—Å–∫–≤–∞, —É–ª. –ü—Ä–∏–º–µ—Ä–Ω–∞—è, 1\n2. –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥, –ø—Ä. –°–∫–ª–∞–¥—Å–∫–æ–π, 5\n3. –ö–∞–∑–∞–Ω—å, —É–ª. –õ–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–∞—è, 10',
                    action: 'warehouses_list',
                    badge: '–ê–¥—Ä–µ—Å–∞'
                },
                {
                    title: '–ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã',
                    message: '–ú—ã —Ä–∞–±–æ—Ç–∞–µ–º:\n–ü–Ω-–ü—Ç: 9:00 - 18:00\n–°–±: 10:00 - 15:00\n–í—Å: –≤—ã—Ö–æ–¥–Ω–æ–π',
                    action: 'working_hours',
                    badge: '–ì—Ä–∞—Ñ–∏–∫'
                }
            ]
        },
        'shipping': {
            title: 'üöö –î–æ—Å—Ç–∞–≤–∫–∞',
            items: [
                {
                    title: '–£—Å–ª–æ–≤–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏',
                    message: '–î–æ—Å—Ç–∞–≤–∫–∞ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ 2-5 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π. –ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ –ø—Ä–∏ –∑–∞–∫–∞–∑–µ –æ—Ç 5000 —Ä—É–±.',
                    action: 'shipping_info',
                    badge: '–ò–Ω—Ñ–æ'
                },
                {
                    title: '–û—Ç—Å–ª–µ–¥–∏—Ç—å –∑–∞–∫–∞–∑',
                    message: '–î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞. –Ø –ø—Ä–æ–≤–µ—Ä—é —Å—Ç–∞—Ç—É—Å –¥–ª—è –≤–∞—Å.',
                    action: 'track_order',
                    badge: '–¢—Ä–µ–∫–∏–Ω–≥'
                }
            ]
        },
        'closing': {
            title: 'üëã –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ',
            items: [
                {
                    title: '–ü—Ä–æ—â–∞–Ω–∏–µ',
                    message: '–°–ø–∞—Å–∏–±–æ –∑–∞ –æ–±—Ä–∞—â–µ–Ω–∏–µ! –í—Å–µ–≥–¥–∞ —Ä–∞–¥—ã –ø–æ–º–æ—á—å. –•–æ—Ä–æ—à–µ–≥–æ –¥–Ω—è!',
                    action: 'goodbye',
                    badge: '–°—Ç–∞–Ω–¥–∞—Ä—Ç'
                }
            ]
        }
    };

    let isLoaded = false;
    let isBX24Ready = false;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è BX24
    BX24.init(function() {
        isBX24Ready = true;
        console.log('‚úÖ BX24 –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ placement
        checkPlacementInstalled();
    });

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ placement
    function checkPlacementInstalled() {
        BX24.callMethod('placement.list', {}, function(result) {
            if(result.error()) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ placement:', result.error());
                return;
            }
            
            const placements = result.data();
            const hasImPlacement = placements.some(p => p.placement === 'IM_TEXTAREA_ICON');
            
            if(!hasImPlacement) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —É—Å—Ç–∞–Ω–æ–≤–∫–∏
                document.getElementById('installButton').style.display = 'block';
                showAlert('info', '‚ö†Ô∏è –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –≤ —á–∞—Ç. –ù–∞–∂–º–∏—Ç–µ "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤ —á–∞—Ç" –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏.');
            } else {
                console.log('‚úÖ Placement —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
            }
        });
    }

    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ placement
    function installPlacement() {
        if(!isBX24Ready) {
            showAlert('danger', '‚ùå BX24 –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
            return;
        }

        const btn = document.getElementById('installButton');
        btn.disabled = true;
        btn.innerHTML = '‚è≥ –£—Å—Ç–∞–Ω–æ–≤–∫–∞...';

        BX24.callMethod(
            'placement.bind',
            {
                PLACEMENT: 'IM_TEXTAREA_ICON',
                HANDLER: 'https://palmocean.github.io/testbitrixbutton/',
                TITLE: '–ë—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã',
                DESCRIPTION: '–®–∞–±–ª–æ–Ω—ã –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤',
                LANG_ALL: {
                    ru: {
                        TITLE: '–ë—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã',
                        DESCRIPTION: '–®–∞–±–ª–æ–Ω—ã –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤'
                    }
                }
            },
            function(result) {
                if(result.error()) {
                    console.error('–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏:', result.error());
                    showAlert('danger', '‚ùå –û—à–∏–±–∫–∞: ' + result.error());
                    btn.disabled = false;
                    btn.innerHTML = 'üìå –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤ —á–∞—Ç';
                } else {
                    console.log('‚úÖ Placement —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:', result.data());
                    showAlert('success', '‚úÖ –£—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ! –¢–µ–ø–µ—Ä—å –æ—Ç–∫—Ä–æ–π—Ç–µ –ª—é–±–æ–π —á–∞—Ç –∏ –Ω–∞–π–¥–∏—Ç–µ –∏–∫–æ–Ω–∫—É "–ë—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã"');
                    btn.style.display = 'none';
                }
            }
        );
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –∞–ª–µ—Ä—Ç
    function showAlert(type, message) {
        const alertDiv = document.getElementById('installAlert');
        alertDiv.className = `alert alert-${type}`;
        alertDiv.innerHTML = message;
        alertDiv.style.display = 'block';
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–≤–µ—Ç–æ–≤
    function loadAnswers() {
        if (isLoaded) {
            alert('–û—Ç–≤–µ—Ç—ã —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!');
            return;
        }

        const loadButton = document.getElementById('loadButton');
        const loadingIndicator = document.getElementById('loadingIndicator');

        loadButton.style.display = 'none';
        loadingIndicator.style.display = 'block';

        setTimeout(() => {
            createList();
            loadingIndicator.style.display = 'none';
            isLoaded = true;
        }, 800);
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏
    function createList() {
        const answerList = document.getElementById('answerList');
        answerList.innerHTML = '';

        for (const categoryKey in templates) {
            const category = templates[categoryKey];
            
            answerList.innerHTML += `
                <li class="list-group-item category-header">
                    ${category.title}
                </li>
            `;

            category.items.forEach(item => {
                answerList.innerHTML += `
                    <li class="list-group-item" 
                        onclick="sendMessage('${escapeString(item.message)}', '${item.action}')">
                        ${item.title}
                        ${item.badge ? `<span class="badge bg-secondary">${item.badge}</span>` : ''}
                    </li>
                `;
            });
        }
    }

    // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫
    function escapeString(str) {
        return str.replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, '\\n');
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    function sendMessage(message, action) {
        executeAction(action, message);
        frameCommunicationSend({
            'action': 'send', 
            'message': message
        });
    }

    // –õ–æ–≥–∏–∫–∞ –¥–µ–π—Å—Ç–≤–∏–π
    function executeAction(actionType, message) {
        console.log(`–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–µ–π—Å—Ç–≤–∏–µ: ${actionType}`);
        
        switch(actionType) {
            case 'greeting':
            case 'greeting_evening':
                console.log('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ');
                logToAnalytics('greeting_sent', message);
                break;
                
            case 'warehouses_list':
                console.log('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω —Å–ø–∏—Å–æ–∫ —Å–∫–ª–∞–¥–æ–≤');
                logToAnalytics('warehouses_info_sent', message);
                break;
                
            case 'track_order':
                console.log('–ó–∞–ø—Ä–æ—Å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞');
                logToAnalytics('tracking_requested', message);
                break;
                
            case 'shipping_info':
                console.log('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ—Å—Ç–∞–≤–∫–µ');
                logToAnalytics('shipping_info_sent', message);
                break;
                
            case 'goodbye':
                console.log('–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞');
                logToAnalytics('conversation_closed', message);
                break;
                
            default:
                console.log('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ:', actionType);
        }
    }

    // –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
    function logToAnalytics(eventName, data) {
        console.log('Analytics:', eventName, data);
    }

    // Frame Communication (–¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç)
    function frameCommunicationInit() {
        if (!window.frameCommunication) {
            window.frameCommunication = {timeout: {}};
        }
        if(typeof window.postMessage === 'function') {
            window.addEventListener('message', function(event){
                var data = {};
                try { data = JSON.parse(event.data); } catch (err){}

                if (data.action == 'init') {
                    frameCommunication.uniqueLoadId = data.uniqueLoadId;
                    frameCommunication.postMessageSource = event.source;
                    frameCommunication.postMessageOrigin = event.origin;
                }
            });
        }
    }

    function frameCommunicationSend(data) {
        data['uniqueLoadId'] = frameCommunication.uniqueLoadId;
        var encodedData = JSON.stringify(data);
        
        if (!frameCommunication.postMessageOrigin) {
            clearTimeout(frameCommunication.timeout[encodedData]);
            frameCommunication.timeout[encodedData] = setTimeout(function(){
                frameCommunicationSend(data);
            }, 10);
            return true;
        }

        if(typeof window.postMessage === 'function') {
            if(frameCommunication.postMessageSource) {
                frameCommunication.postMessageSource.postMessage(
                    encodedData,
                    frameCommunication.postMessageOrigin
                );
            }
        }
    }

    frameCommunicationInit();
</script>
</body>
</html>
