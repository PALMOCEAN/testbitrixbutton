<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Установка приложения</title>
    <script src="//api.bitrix24.com/api/v1/"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            text-align: center;
        }
        .status {
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .loading {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            padding: 10px 30px;
            font-size: 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <h1>Установка приложения "Быстрые ответы"</h1>
    
    <div id="status" class="status loading">
        Инициализация...
    </div>
    
    <button id="installBtn" onclick="installPlacement()" disabled>
        Установить встраивание в чат
    </button>
    
    <div id="result"></div>

<script>
    let isInitialized = false;
    
    // Инициализация BX24
    BX24.init(function() {
        isInitialized = true;
        document.getElementById('status').className = 'status success';
        document.getElementById('status').innerHTML = '✅ Соединение с Bitrix24 установлено!';
        document.getElementById('installBtn').disabled = false;
        
        console.log('BX24 инициализирован успешно');
        
        // Автоматически проверяем существующие placements
        checkExistingPlacements();
    });
    
    // Проверка существующих размещений
    function checkExistingPlacements() {
        BX24.callMethod(
            'placement.list',
            {},
            function(result) {
                if(result.error()) {
                    console.error('Ошибка при проверке placements:', result.error());
                } else {
                    console.log('Существующие placements:', result.data());
                    const placements = result.data();
                    const hasImPlacement = placements.some(p => p.placement === 'IM_TEXTAREA_ICON');
                    
                    if(hasImPlacement) {
                        document.getElementById('status').innerHTML = 
                            '✅ Приложение уже установлено в чат!<br><small>Откройте любой чат и найдите иконку</small>';
                        document.getElementById('installBtn').innerHTML = 'Переустановить';
                    }
                }
            }
        );
    }
    
    // Установка placement
    function installPlacement() {
        const btn = document.getElementById('installBtn');
        btn.disabled = true;
        btn.innerHTML = 'Установка...';
        
        document.getElementById('status').className = 'status loading';
        document.getElementById('status').innerHTML = '⏳ Установка размещения в чат...';
        
        BX24.callMethod(
            'placement.bind',
            {
                PLACEMENT: 'IM_TEXTAREA_ICON',
                HANDLER: 'https://palmocean.github.io/testbitrixbutton/',
                TITLE: 'Быстрые ответы',
                DESCRIPTION: 'Шаблоны для быстрых ответов',
                LANG_ALL: {
                    ru: {
                        TITLE: 'Быстрые ответы',
                        DESCRIPTION: 'Шаблоны для быстрых ответов'
                    },
                    en: {
                        TITLE: 'Quick Replies',
                        DESCRIPTION: 'Templates for quick replies'
                    }
                }
            },
            function(result) {
                btn.disabled = false;
                btn.innerHTML = 'Переустановить';
                
                if(result.error()) {
                    console.error('Ошибка установки:', result.error());
                    document.getElementById('status').className = 'status error';
                    document.getElementById('status').innerHTML = 
                        '❌ Ошибка: ' + result.error() + 
                        '<br><small>' + result.error_description() + '</small>';
                } else {
                    console.log('✅ Placement установлен:', result.data());
                    document.getElementById('status').className = 'status success';
                    document.getElementById('status').innerHTML = 
                        '✅ Успешно установлено!<br>' +
                        '<small>ID placement: ' + result.data() + '</small><br><br>' +
                        '<strong>Теперь откройте любой чат в Bitrix24 и найдите иконку "Быстрые ответы"</strong>';
                    
                    // Показываем результат
                    document.getElementById('result').innerHTML = 
                        '<pre>' + JSON.stringify(result.data(), null, 2) + '</pre>';
                }
            }
        );
    }
    
    // Таймаут для инициализации
    setTimeout(function() {
        if(!isInitialized) {
            document.getElementById('status').className = 'status error';
            document.getElementById('status').innerHTML = 
                '❌ Не удалось подключиться к Bitrix24<br>' +
                '<small>Убедитесь что открыли эту страницу из локального приложения в Bitrix24</small>';
        }
    }, 5000);
</script>
</body>
</html>
